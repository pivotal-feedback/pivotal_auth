# PivotalAuth

## Setup

To install, add this line to your Gemfile:

	gem "pivotal_auth", github: "pivotal/pivotal_auth", branch: "dev"

Add this line in your routes:

	mount PivotalAuth::Engine, at: '/'

Make sure you also have a root route defined. This is where users will be redirected to after login, unless they have previously visited a page that requires authentication.

Run these lines:

	bundle
	rails g pivotal_auth:init
	
This will create a template file in `config/initializers/omniauth.rb`.

## Environment Variables and Setup

###Okta

The gem requires two env variables for Okta auth: `OKTA_LOGIN_URL` and `OKTA_CERT_FINGERPRINT`. These are specific to the Okta app you are authenticating against.

To get these values, follow the [instructions](https://github.com/primedia/okta_saml#okta-configuration) under "Okta Configuration" and "Configuration". Step 1 of the "Configuration" instructions refers to `OKTA_LOGIN_URL`. Step 2 of the instructions refers to `OKTA_CERT_FINGERPRINT`.

In `config/initializers/omniauth.rb`, in the OmniAuth config block for provider :saml, replace the placeholder string values with pointers to your Okta environment variables.

###Google Oauth2

The gem also requires two env variables for Google auth: `GOOGLE_CLIENT_I`' and `GOOGLE_CLIENT_SECRET`. Your app must be registered with Google and configured to allow Oauth authentication. For more information check out the Google doc: https://developers.google.com/accounts/docs/OAuth2.

In `config/initializers/omniauth.rb`, in the OmniAuth config block for provider :google_oauth, replace the placeholder string values with pointers to your Google environment variables.

## Routes

The engine will generate the following routes:

- Login: `/login`
- Logout: `/logout`

## Useful Controller/View Helper Methods

- `current_user_email` - Returns the email of the currently logged in user.
- `user_signed_in?` - Returns if a user is signed in
- `authenticate_user!` - A before filter that will redirect to '/login' if no user is signed in. It will also set a redirect url to the current path.


## Styling and Layouts

By default the gem will use the layout and stylesheets defined in your ApplicationController. NOTE: Any path helpers used in these layout files must be pre-pended with 'main_app' in order to render correctly. For example, `user_show_path` becomes `main_app.user_show_path`. Routes generated by the gem must be pre-pended with 'pivotal_auth', e.g. `pivotal_auth.logout_path`.

## Testing

The gem uses OmniAuth for both Google and Okta authentication. In order to stub the authentication process, include the following in `spec/support/omniauth.rb`:

    OmniAuth.config.test_mode = true

When you want to login in a user in test, use the following:

    OmniAuth.config.mock_auth[:saml] = OmniAuth::AuthHash.new(
        {
            uid: user.email
        }
    )

    OmniAuth.config.mock_auth[:google_oauth2] = OmniAuth::AuthHash.new(
        {
            uid: user.email

        }
    )

##Contact

Currently maintained by [Molly Trombley-McCann](mailto:mtrombleymccann@pivotal.io) and [Alex Choi](mailto:achoi@pivotal.io)
